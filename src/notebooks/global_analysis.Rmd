---
title: "global_analysis"
author: "Nathaniel Imel"
date: "2024-02-16"
output: html_document
---

```{r setup}
library(tidyverse)
library(lme4)
library(modelr)
library(viridis)
library(ggrepel)
library(latex2exp)
```


```{r load data}
df <- read_csv("../../analysis_data/all_data.csv")
head(df)
```


```{r transform}

df <- df %>% filter(
  citations_per_year > 0,
) %>% mutate(
  log_cpy = log10(citations_per_year),
)
head(df)
```


```{r estimator}


# Compute entropy for each bin
entropy_estimator <- function(observations, num_bins = 20) {
  if (length(observations) == 0) {
    return(NaN)
  }
  
  # Calculate bin width for each dimension
  bin_width <- num_bins / 21

  # Compute histogram
  # Compute histogram
  # we could use seq(min_value, max_value, length.out = num_bins + 1),
  # but since we essentially filter to <=10 cpys anyway, just estimate this range evenly
  hist <- hist(observations, breaks = 0:num_bins, plot = FALSE)

  # Compute probabilities for each bin
  bin_probabilities <- hist$counts / length(observations)

  # Calculate entropy for this dimension
  entropy_estimate <- -sum(bin_probabilities * log(bin_probabilities + 1e-16) / bin_width)  # Add small value to avoid log(0)

  return(entropy_estimate)
}

```


```{r cutbins}

num_bins = 20

df$density_bin <- cut(
  df$density, 
  breaks = seq(
    min(df$density), 
    max(df$density), 
    length.out = num_bins+1
  )
)
head(df)
```

```{r measure}


value_counts <-  count(df, density_bin)
density_bin_counts <- value_counts$n
density_levels <- value_counts$density_bin

cpy_ents <- c()
bin_starts <- c()
for (val in density_levels) {
  # need to do some regexing on the density bin name string
  text <- val
  pattern <- "\\(([-+]?[0-9]*\\.?[0-9]+),"
  numbers <- str_extract_all(text, pattern)
  start <- as.double(lapply(numbers[[1]], function(x) gsub("[(,]", "", x)))

  # now filter and compute entropy
  df_val <- df %>% filter(density_bin == val)
  cpy_values <- unlist(c(df_val["citations_per_year"]))
  h <- entropy_estimator(cpy_values)
  cpy_ents <- append(cpy_ents, h)
  bin_starts <- append(bin_starts, start)
}

df_ent <- tibble(cpy_ents, bin_starts, density_bin_counts)
cpy_ent <- (
  ggplot(
    df_ent,
    aes(
      x=bin_starts,      
      y=density_bin_counts,
      fill=cpy_ents,
    )
  )
  # + geom_point(size=10)
  + geom_col()
  + scale_fill_viridis()
  + labs(fill="citation entropy,\nH(CPY | density_bin)\n")
)

```